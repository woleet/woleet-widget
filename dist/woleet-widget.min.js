"use strict";!function(e){function t(e){function t(){n(),w.inputContainer.mainTextZone.text("Drop the file to verify"),x.removeClass(["validated","error"]),x.hide(),w.show(),b.hide(),v.reset.hide(),v.cancel.hide(),v.receipt.hide()}function n(){w.inputContainer.mainTextZone.text(""),w.inputContainer.subTextZone.text(""),x.mainTextZone.text(""),x.subTextZone.text(""),x.signTextZone.text(""),x.warnTextZone.text("")}function i(e){var t=void 0,n=void 0,i=void 0,r=void 0,o=void 0;return t=e.getDate(),n=e.getMonth(),i=e.getFullYear(),r=e.getHours(),o=e.getMinutes(),[t,n+1,i].join("/")+" "+[r,o].join(":")}function r(){var e=this.files[0];if(e){this.value=null,"done"===l.state&&s("init");var t=function(e){var t=100*e.progress;Number.isNaN(t)&&(t=0),t=t.toFixed(0),g.style({width:t+"%"}),b.percentage.text("Hashing... "+t+"%")};if("needReceipt"===l.state)s("pending"),c(e).then(function(e){return woleet.verify.DAB(l.hash,e,t)}).then(function(e){if("verified"!==e.code)throw new Error(e.code);s("woleet-ok",e),l.state="done"}).catch(function(e){s("error",e)});else{var n=function(e){woleet.verify.WoleetDAB(e,t).then(function(e){if(!e.length)throw new Error("need-receipt");l.state="done";var t=e[0];if("verified"!==t.code)throw new Error(t.code);s("woleet-ok",t)}).catch(function(e){console.log(e),e.hasOwnProperty("code")||"need-receipt"===e.message?(l.state="needReceipt",s("need-receipt")):s("error",e)})};s("pending"),"string"==typeof e?(l.hash=e,n(l.hash)):(T.start(e),T.on("progress",t),T.on("result",function(e){l.hash=e.result,n(l.hash),t({progress:0})}))}}}function o(){l.state="needReceipt",s("need-receipt"),w.inputContainer.mainTextZone.text("Drop file's receipt"),w.inputContainer.subTextZone.text("")}function a(e){e instanceof Error&&(e=e.message);var t={};switch(e){case"need-receipt":t.main="File unknown to Woleet",t.sub="The receipt cannot be retreived from Woleet: you must provide it to verify this file";break;case"target_hash_mismatch":t.main="The provided receipt is not meant for this file",t.sub="The receipt's target_hash attribute doesn't match the file hash";break;case"unable_to_parse_json":t.main="The provided receipt cannot be parsed",t.sub="The file you provided doesn't look like a receipt";break;case"merkle_root_mismatch":t.main="The provided receipt seems corrupted",t.sub="The receipt's merkle_root attribute does not match the proof result";break;case"non_sha256_target_proof_element":t.main="The provided receipt seems corrupted",t.sub="An attribute in the proof (parent or left or right) in not a SHA256 hash";break;case"invalid_parent_in_proof_element":t.main="The provided receipt seems corrupted",t.sub="A parent in the proof does not match SHA256(left+right).";break;case"invalid_receipt_format":t.main="The provided receipt seems corrupted",t.sub="The proof miss an attribute (parent or left or right).";break;case"invalid_target_proof":t.main="The provided receipt seems corrupted",t.sub="The receipt does not conform to the Chainpoint 1.x format";break;case"tx_not_found":t.main="Transaction not found",t.sub="The transaction targeted by the receipt cannot be found";break;case"invalid_receipt_signature":t.main="Invalid receipt signature",t.sub="The provided receipt is packed with a signature field witch is invalid";break;case"error_while_getting_transaction":t.main="Cannot get transaction",t.sub="There was an error while getting the transaction (try again)";break;default:console.trace("unexpected case",e),t.main=e,t.sub="unexpected case"}return t}function s(e,r){switch(e){case"woleet-ok":n(),x.removeClass(["error"]),x.show(),w.hide(),b.hide(),v.cancel.hide();var o=r.receipt.signature,s=r.identityVerificationStatus,c=o?o.pubKey:null,d=o&&o.identityURL&&s&&"verified"===s.code?o.identityURL:c,u=i(r.timestamp).split(" "),h=/.*(GMT.*\)).*/.exec(r.timestamp.toString())[1];x.mainTextZone.text((c?"Signed":"Timestamped")+" on "+u[0]),x.subTextZone.text("at "+u[1]+" "+h),x.signTextZone.text(c?"by "+d:""),s&&s.code&&"verified"!==s.code&&x.warnTextZone.text("Cannot validate identity ("+s.code+")"),x.addClass("validated"),w.attr("disabled",!0),v.reset.show(),v.receipt.show();break;case"need-receipt":n(),x.hide(),w.show(),b.hide(),v.cancel.hide(),v.receipt.hide(),w.inputContainer.mainTextZone.text("File unknown to Woleet"),w.inputContainer.subTextZone.text("Drop it's receipt"),v.reset.show();break;case"error":n(),x.removeClass(["validated"]),x.show(),w.hide(),b.hide(),v.cancel.hide(),"needReceipt"===l.state&&v.receipt.show();var p=a(r);x.mainTextZone.text(p.main),x.subTextZone.text(p.sub),x.addClass("error"),v.reset.show();break;case"pending":n(),v.cancel.show(),v.receipt.hide(),x.hide(),w.hide(),b.show();break;case"init":default:t()}}function c(e){return new Promise(function(t,n){var i=new FileReader;i.onloadend=function(e){try{t(JSON.parse(e.target.result))}catch(e){n(new Error("unable_to_parse_json"))}},i.readAsText(e)})}function d(){s("init"),l.hash=null,l.state="initial"}function u(){T.cancel(),d()}if(e&&"string"!=typeof e)throw new Error("Invalid parameter type");var l={state:"initial",hash:null},h=function e(t,n){if(t instanceof Element);else{if("string"!=typeof t)throw new TypeError;var i=document.createElement(i);n&&i.addClass(n)}var r=t,o=this,a=function(){return o},s=function(e,t){return Object.defineProperty(o,e,{enumerable:!1,value:t})};s("target",function(){return r}),s("removeClass",function(e){return a(Array.isArray(e)?e.forEach(function(e){return r.classList.remove(e)}):r.classList.remove(e))}),s("addClass",function(e){return a(Array.isArray(e)?e.forEach(function(e){return r.classList.add(e)}):r.classList.add(e))}),s("text",function(e,t){return a(t?r.innerText+=e:r.innerText=e)}),s("show",function(){return o.removeClass("hidden")}),s("hide",function(){return o.addClass("hidden")}),s("style",function(e){if(Array.isArray(e))return e.map(function(e){return r.style[e]});if("string"==typeof e)return r.style[e];for(var t in e)r.style[t]=e[t]}),s("attr",function(e,t){return a(t?r.setAttribute(e,t):r.removeAttribute(e))}),s("on",function(e,t,n){return a(r.addEventListener(e,t,n))}),s("toDom",function(){var t=o.target();for(var n in o)if(o.hasOwnProperty(n)&&!(!n instanceof e))try{t.appendChild(o[n].toDom())}catch(e){console.log(n,e)}return t})},p=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"div",t=arguments[1],n=new h(document.createElement(e));return t&&n.addClass(t),n},f=p("div","widget"),v=f.head=p("div","head");v.logo=p("div","woleet-logo"),v.reset=p("div",["reset","mini-button","clickable"]).on("click",d),v.cancel=p("div",["cancel","mini-button","clickable"]).on("click",u),v.receipt=p("button",["receipt-button","clickable"]).on("click",o).text("Drop receipt");var m=f.body=p("div","body"),b=m.hashZone=p("div","hashZone");b.hashProgessContainer=p("div","progressBarContainer"),b.percentage=p("span").text("Hashing... 0%");var g=b.hashProgessContainer.progressBar=p("div","progressBar"),x=m.infoZone=p("div","infoZone");x.icon=p("div","infoStatus"),x.mainTextZone=p("div","text"),x.subTextZone=p("div",["text","small"]),x.signTextZone=p("div",["text","x-small"]),x.warnTextZone=p("div",["text","x-small","warn"]);var w=m.dropZone=p("div","dropZoneContainer");w.inputContainer=p("div"),w.inputContainer.mainTextZone=p("div","text"),w.inputContainer.subTextZone=p("div",["text","small"]),w.inputContainer.input=p("input",["dropZone","clickable"]).attr("type","file").on("change",r),t(),e&&r.call({files:[e]});var T=new woleet.file.Hasher;return f.toDom()}document.addEventListener("DOMContentLoaded",function(){for(var e=document.getElementsByClassName("woleet-widget"),n=0;n<e.length;n++){var i=e[n],r=i.getAttribute("data-hash");i.appendChild(new t(r))}}),e.Widget=t}(window);
//# sourceMappingURL=woleet-widget.min.js.map
