"use strict";!function(e){function t(e){function t(){n(),w.inputContainer.mainTextZone.text("Drop the file to verify"),x.removeClass(["validated","error"]),x.hide(),w.show(),b.hide(),v.reset.hide(),v.cancel.hide(),v.receipt.hide()}function n(){w.inputContainer.mainTextZone.clear(),w.inputContainer.subTextZone.clear(),x.mainTextZone.clear(),x.subTextZone.clear(),x.signTextZone.clear(),x.warnTextZone.clear(),x.byTextZone.hide()}function r(e){var t=void 0,n=void 0,r=void 0,i=void 0,o=void 0;return t=e.getDate(),n=e.getMonth(),r=e.getFullYear(),i=e.getHours(),o=e.getMinutes(),[t,n+1,r].join("/")+" "+[i,o].join(":")}function i(){var e=this.files[0];if(e){this.value=null,"done"===l.state&&s("init");var t=function(e){var t=100*e.progress;Number.isNaN(t)&&(t=0),t=t.toFixed(0),g.style({width:t+"%"}),b.percentage.text("Hashing... "+t+"%")};if("needReceipt"===l.state)s("pending"),c(e).then(function(e){return woleet.verify.DAB(l.hash,e,t)}).then(function(e){if("verified"!==e.code)throw new Error(e.code);s("woleet-ok",e),l.state="done"}).catch(function(e){s("error",e)});else{var n=function(e){woleet.verify.WoleetDAB(e,t).then(function(e){if(!e.length)throw new Error("need-receipt");l.state="done";var t=e[0];if("verified"!==t.code)throw new Error(t.code);s("woleet-ok",t)}).catch(function(e){console.trace(e),e.hasOwnProperty("code")||"need-receipt"===e.message?(l.state="needReceipt",s("need-receipt")):s("error",e)})};s("pending"),"string"==typeof e?(l.hash=e,n(l.hash)):(T.start(e),T.on("progress",t),T.on("result",function(e){l.hash=e.result,n(l.hash),t({progress:0})}))}}}function o(){l.state="needReceipt",s("need-receipt"),w.inputContainer.mainTextZone.text("Drop file's receipt"),w.inputContainer.subTextZone.clear()}function a(e){e instanceof Error&&(e=e.message);var t={};switch(e){case"need-receipt":t.main="File unknown to Woleet",t.sub="The receipt cannot be retreived from Woleet: you must provide it to verify this file";break;case"target_hash_mismatch":t.main="The provided receipt is not meant for this file",t.sub="The receipt's target_hash attribute doesn't match the file hash";break;case"unable_to_parse_json":t.main="The provided receipt cannot be parsed",t.sub="The file you provided doesn't look like a receipt";break;case"merkle_root_mismatch":t.main="The provided receipt seems corrupted",t.sub="The receipt's merkle_root attribute does not match the proof result";break;case"non_sha256_target_proof_element":t.main="The provided receipt seems corrupted",t.sub="An attribute in the proof (parent or left or right) in not a SHA256 hash";break;case"invalid_parent_in_proof_element":t.main="The provided receipt seems corrupted",t.sub="A parent in the proof does not match SHA256(left+right).";break;case"invalid_receipt_format":t.main="The provided receipt seems corrupted",t.sub="The proof miss an attribute (parent or left or right).";break;case"invalid_target_proof":t.main="The provided receipt seems corrupted",t.sub="The receipt does not conform to the Chainpoint 1.x format";break;case"tx_not_found":t.main="Transaction not found",t.sub="The transaction targeted by the receipt cannot be found";break;case"invalid_receipt_signature":t.main="Invalid receipt signature",t.sub="The provided receipt is packed with a signature field witch is invalid";break;case"error_while_getting_transaction":t.main="Cannot get transaction",t.sub="There was an error while getting the transaction (try again)";break;default:console.trace("unexpected case",e),t.main=e,t.sub="unexpected case"}return t}function s(e,i){switch(e){case"woleet-ok":n(),x.removeClass(["error"]),x.show(),w.hide(),b.hide(),v.cancel.hide();var o=i.receipt.signature,s=i.identityVerificationStatus,c=o?o.pubKey:null,d=r(i.timestamp).split(" "),u=/.*(GMT.*\)).*/.exec(i.timestamp.toString())[1];x.mainTextZone.text((c?"Signed":"Timestamped")+" on "+d[0]),x.subTextZone.text("at "+d[1]+" "+u),o&&o.identityURL&&s&&"verified"===s.code?(x.signTextZone.link(o.identityURL),x.byTextZone.show()):c?(x.signTextZone.text(""+c),x.byTextZone.show()):x.byTextZone.hide(),s&&s.code&&"verified"!==s.code&&x.warnTextZone.text("Cannot validate identity ("+s.code+")"),x.addClass("validated"),w.attr("disabled",!0),v.reset.show(),v.receipt.show();break;case"need-receipt":n(),x.hide(),w.show(),b.hide(),v.cancel.hide(),v.receipt.hide(),w.inputContainer.mainTextZone.text("File unknown to Woleet"),w.inputContainer.subTextZone.text("Drop it's receipt"),v.reset.show();break;case"error":n(),x.removeClass(["validated"]),x.show(),w.hide(),b.hide(),v.cancel.hide(),"needReceipt"===l.state&&v.receipt.show();var h=a(i);x.mainTextZone.text(h.main),x.subTextZone.text(h.sub),x.addClass("error"),v.reset.show();break;case"pending":n(),v.cancel.show(),v.receipt.hide(),x.hide(),w.hide(),b.show();break;case"init":default:t()}}function c(e){return new Promise(function(t,n){var r=new FileReader;r.onloadend=function(e){try{t(JSON.parse(e.target.result))}catch(e){n(new Error("unable_to_parse_json"))}},r.readAsText(e)})}function d(){s("init"),l.hash=null,l.state="initial"}function u(){T.cancel(),d()}if(e&&"string"!=typeof e)throw new Error("Invalid parameter type");var l={state:"initial",hash:null},h=function e(t,n){if(t instanceof Element);else{if("string"!=typeof t)throw new TypeError;var r=document.createElement(r);n&&r.addClass(n)}var i=t,o=this,a=function(){return o},s=function(e,t){return Object.defineProperty(o,e,{enumerable:!1,value:t})};s("target",function(){return i}),s("attr",function(e,t){return a(t?i.setAttribute(e,t):i.removeAttribute(e))}),s("removeClass",function(e){return a(Array.isArray(e)?e.forEach(function(e){return i.classList.remove(e)}):i.classList.remove(e))}),s("addClass",function(e){return a(Array.isArray(e)?e.forEach(function(e){return i.classList.add(e)}):i.classList.add(e))}),s("text",function(e,t){return a(t?i.innerText+=e:i.innerText=e)}),s("link",function(e){return a(o.text(e).attr("href",e))}),s("clear",function(){return a(o.text(""),o.attr("href",null))}),s("show",function(){return o.removeClass("hidden")}),s("hide",function(){return o.addClass("hidden")}),s("style",function(e){if(Array.isArray(e))return e.map(function(e){return i.style[e]});if("string"==typeof e)return i.style[e];for(var t in e)i.style[t]=e[t]}),s("on",function(e,t,n){return a(i.addEventListener(e,t,n))}),s("toDom",function(){var t=o.target();for(var n in o)if(o.hasOwnProperty(n)&&!(!n instanceof e))try{t.appendChild(o[n].toDom())}catch(e){console.log(n,e)}return t})},p=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"div",t=arguments[1],n=new h(document.createElement(e));return t&&n.addClass(t),n},f=p("div","widget"),v=f.head=p("div","head");v.logo=p("div","woleet-logo"),v.reset=p("div",["reset","mini-button","clickable"]).on("click",d),v.cancel=p("div",["cancel","mini-button","clickable"]).on("click",u),v.receipt=p("button",["receipt-button","clickable"]).on("click",o).text("Drop receipt");var m=f.body=p("div","body"),b=m.hashZone=p("div","hashZone");b.hashProgessContainer=p("div","progressBarContainer"),b.percentage=p("span").text("Hashing... 0%");var g=b.hashProgessContainer.progressBar=p("div","progressBar"),x=m.infoZone=p("div","infoZone");x.icon=p("div","infoStatus"),x.mainTextZone=p("div","text"),x.subTextZone=p("div",["text","small"]),x.byTextZone=p("span",["text","x-small"]).text("by"),x.signTextZone=p("a",["text","x-small"]),x.warnTextZone=p("div",["text","x-small","warn"]);var w=m.dropZone=p("div","dropZoneContainer");w.inputContainer=p("div"),w.inputContainer.mainTextZone=p("div","text"),w.inputContainer.subTextZone=p("div",["text","small"]),w.inputContainer.input=p("input",["dropZone","clickable"]).attr("type","file").on("change",i),t(),e&&i.call({files:[e]});var T=new woleet.file.Hasher;return f.toDom()}document.addEventListener("DOMContentLoaded",function(){for(var e=document.getElementsByClassName("woleet-widget"),n=0;n<e.length;n++){var r=e[n],i=r.getAttribute("data-hash");r.appendChild(new t(i))}}),e.Widget=t}(window);
//# sourceMappingURL=woleet-widget.min.js.map
