"use strict";!function(e){function t(e){function t(){n(),x.inputContainer.mainTextZone.text("Drop the file to verify"),b.removeClass(["validated","error"]),b.hide(),x.show(),m.hide(),f.reset.hide(),f.cancel.hide()}function n(){x.inputContainer.mainTextZone.text(""),x.inputContainer.subTextZone.text(""),b.mainTextZone.text(""),b.subTextZone.text(""),b.signTextZone.text(""),b.warnTextZone.text("")}function r(e){var t=void 0,n=void 0,r=void 0,i=void 0,o=void 0;return t=e.getDate(),n=e.getMonth(),r=e.getFullYear(),i=e.getHours(),o=e.getMinutes(),[t,n+1,r].join("/")+" "+[i,o].join(":")}function i(){var e=this.files[0];if(e){this.value=null,"done"===u.state&&a("init");var t=function(e){var t=100*e.progress;Number.isNaN(t)&&(t=0),t=t.toFixed(0),g.style({width:t+"%"}),m.percentage.text("Hashing... "+t+"%")};if("needReceipt"===u.state)a("pending"),s(e).then(function(e){return woleet.verify.DAB(u.hash,e,t)}).then(function(e){if("verified"!==e.code)throw new Error(e.code);a("woleet-ok",e),u.state="done"}).catch(function(e){a("error",e)});else{var n=function(e){woleet.verify.WoleetDAB(e,t).then(function(e){if(!e.length)throw new Error("need-receipt");u.state="done";var t=e[0];if("verified"!==t.code)throw new Error(t.code);a("woleet-ok",t)}).catch(function(e){console.log(e),e.hasOwnProperty("code")||"need-receipt"===e.message?(u.state="needReceipt",a("need-receipt")):a("error",e)})};a("pending"),"string"==typeof e?(u.hash=e,n(u.hash)):(w.start(e),w.on("progress",t),w.on("result",function(e){u.hash=e.result,n(u.hash),t({progress:0})}))}}}function o(e){e instanceof Error&&(e=e.message);var t={};switch(e){case"need-receipt":t.main="File unknown to Woleet",t.sub="The receipt cannot be retreived from Woleet: you must provide it to verify this file";break;case"target_hash_mismatch":t.main="The provided receipt is not meant for this file",t.sub="The receipt's target_hash attribute doesn't match the file hash";break;case"unable_to_parse_json":t.main="The provided receipt cannot be parsed",t.sub="The file you provided doesn't look like a receipt";break;case"merkle_root_mismatch":t.main="The provided receipt seems corrupted",t.sub="The receipt's merkle_root attribute does not match the proof result";break;case"non_sha256_target_proof_element":t.main="The provided receipt seems corrupted",t.sub="An attribute in the proof (parent or left or right) in not a SHA256 hash";break;case"invalid_parent_in_proof_element":t.main="The provided receipt seems corrupted",t.sub="A parent in the proof does not match SHA256(left+right).";break;case"invalid_receipt_format":t.main="The provided receipt seems corrupted",t.sub="The proof miss an attribute (parent or left or right).";break;case"invalid_target_proof":t.main="The provided receipt seems corrupted",t.sub="The receipt does not conform to the Chainpoint 1.x format";break;case"tx_not_found":t.main="Transaction not found",t.sub="The transaction targeted by the receipt cannot be found";break;case"invalid_receipt_signature":t.main="Invalid receipt signature",t.sub="The provided receipt is packed with a signature field witch is invalid";break;case"error_while_getting_transaction":t.main="Cannot get transaction",t.sub="There was an error while getting the transaction (try again)";break;case"":console.trace("undefined");break;default:console.trace("unexpected case",e),t.main=e,t.sub="unexpected case"}return t}function a(e,i){switch(e){case"woleet-ok":n(),b.show(),x.hide(),m.hide(),f.cancel.hide(),console.log(i);var a=i.receipt.signature,s=i.identityVerificationStatus,d=a?a.pubKey:null,c=a&&a.identityURL&&s&&"verified"===s.code?a.identityURL:d,u=r(i.timestamp).split(" "),l=/.*(GMT.*\)).*/.exec(i.timestamp.toString())[1];b.mainTextZone.text((d?"Signed":"Timestamped")+" on "+u[0]),b.subTextZone.text("at "+u[1]+" "+l),b.signTextZone.text(d?"by "+c:""),s&&s.code&&"verified"!==s.code&&b.warnTextZone.text("Cannot validate identity ("+s.code+")"),b.addClass("validated"),x.attr("disabled",!0),f.reset.show();break;case"need-receipt":n(),b.hide(),x.show(),m.hide(),f.cancel.hide(),x.inputContainer.mainTextZone.text("File unknown to Woleet"),x.inputContainer.subTextZone.text("Drop it's receipt"),f.reset.show();break;case"error":n(),b.show(),x.hide(),m.hide(),f.cancel.hide();var h=o(i);b.mainTextZone.text(h.main),b.subTextZone.text(h.sub),b.addClass("error"),f.reset.show();break;case"pending":n(),f.cancel.show(),b.hide(),x.hide(),m.show();break;case"init":default:t()}}function s(e){return new Promise(function(t,n){var r=new FileReader;r.onloadend=function(e){try{t(JSON.parse(e.target.result))}catch(e){n(new Error("unable_to_parse_json"))}},r.readAsText(e)})}function d(){a("init"),u.hash=null,u.state="initial"}function c(){w.cancel(),d()}if(e&&"string"!=typeof e)throw new Error("Invalid parameter type");var u={state:"initial",hash:null},l=function e(t,n){if(t instanceof Element);else{if("string"!=typeof t)throw new TypeError;var r=document.createElement(r);n&&r.addClass(n)}var i=t,o=this,a=function(){return o},s=function(e,t){return Object.defineProperty(o,e,{enumerable:!1,value:t})};s("target",function(){return i}),s("removeClass",function(e){return a(Array.isArray(e)?e.forEach(function(e){return i.classList.remove(e)}):i.classList.remove(e))}),s("addClass",function(e){return a(Array.isArray(e)?e.forEach(function(e){return i.classList.add(e)}):i.classList.add(e))}),s("text",function(e,t){return a(t?i.innerText+=e:i.innerText=e)}),s("show",function(){return o.removeClass("hidden")}),s("hide",function(){return o.addClass("hidden")}),s("style",function(e){if(Array.isArray(e))return e.map(function(e){return i.style[e]});if("string"==typeof e)return i.style[e];for(var t in e)i.style[t]=e[t]}),s("attr",function(e,t){return a(t?i.setAttribute(e,t):i.removeAttribute(e))}),s("on",function(e,t,n){return a(i.addEventListener(e,t,n))}),s("toDom",function(){var t=o.target();for(var n in o)if(o.hasOwnProperty(n)&&!(!n instanceof e))try{t.appendChild(o[n].toDom())}catch(e){console.log(n,e)}return t})},h=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"div",t=arguments[1],n=new l(document.createElement(e));return t&&n.addClass(t),n},p=h("div","widget"),f=p.head=h("div","head");f.logo=h("div","woleet-logo"),f.reset=h("div",["reset","mini-button","clickable"]).on("click",d),f.cancel=h("div",["cancel","mini-button","clickable"]).on("click",c);var v=p.body=h("div","body"),m=v.hashZone=h("div","hashZone");m.hashProgessContainer=h("div","progressBarContainer"),m.percentage=h("span").text("Hashing... 0%");var g=m.hashProgessContainer.progressBar=h("div","progressBar"),b=v.infoZone=h("div","infoZone");b.icon=h("div","infoStatus"),b.mainTextZone=h("div","text"),b.subTextZone=h("div",["text","small"]),b.signTextZone=h("div",["text","x-small"]),b.warnTextZone=h("div",["text","x-small","warn"]);var x=v.dropZone=h("div","dropZoneContainer");x.inputContainer=h("div"),x.inputContainer.mainTextZone=h("div","text"),x.inputContainer.subTextZone=h("div",["text","small"]),x.inputContainer.input=h("input",["dropZone","clickable"]).attr("type","file").on("change",i),t(),e&&i.call({files:[e]});var w=new woleet.file.Hasher;return p.toDom()}document.addEventListener("DOMContentLoaded",function(){for(var e=document.getElementsByClassName("woleet-widget"),n=0;n<e.length;n++){var r=e[n],i=r.getAttribute("data-hash");r.appendChild(new t(i))}}),e.Widget=t}(window);
//# sourceMappingURL=woleet-widget.min.js.map
